
import sys
sys.setrecursionlimit(50000)

allowed_direction = {
    '^': [(-1, 0)],
    'v': [(1, 0)],
    '<': [(0, -1)],
    '>': [(0, 1)],
    '.': [(-1, 0), (1, 0), (0, -1), (0, 1)],
}
UNVISITED = -1


def get_neighbours(posiiton, visited, all_normal, grid):
    x, y = posiiton
    neighbours = []
    for dx, dy in allowed_direction['.'] if all_normal else allowed_direction[grid[x][y]]:
        nx, ny = x + dx, y + dy
        if 0 <= nx < len(grid) and 0 <= ny < len(grid[0]) and grid[nx][ny] != '#' and (nx, ny) not in visited:
            neighbours.append((nx, ny))
    return neighbours



# def get_longest_hike(posiiton, f, visited, all_normal, grid):
#     x, y = posiiton
#     if x == len(grid) - 1 and y == len(grid[0]) - 2:
#         return 0
#     # if f[x][y] != UNVISITED:
#     #     return f[x][y]
#     longest_hike = -1
#     for next_posiiton in get_neighbours(posiiton, visited, all_normal, grid):
#         visited.add(next_posiiton)
#         if (next_longest_hike := get_longest_hike(next_posiiton, f, visited, all_normal, grid)) != UNVISITED:
#             longest_hike = max(longest_hike, next_longest_hike + 1)
#         visited.remove(next_posiiton)
#     # f[x][y] = longest_hike
#     return longest_hike
    

# def part1(text):
#     grid = text.splitlines()
#     f = [[UNVISITED for _y in range(len(grid[1]))] for _x in range(len(grid))]
#     return get_longest_hike((0, 1), f, set(), False, grid)



# def part2(text):
#     grid = text.splitlines()
#     f = [[UNVISITED for _y in range(len(grid[1]))] for _x in range(len(grid))]
#     return get_longest_hike((0, 1), f, set(), True, grid)



text = '''#.###########################################################################################################################################
#.#.........#.....#...#...###.........#.....#...#.....#.....#####...#...#.......###.....#...#.....#...#.....#####...#.....#...........#.....#
#.#.#######.#.###.#.#.#.#.###.#######.#.###.#.#.#.###.#.###.#####.#.#.#.#.#####.###.###.#.#.#.###.#.#.#.###.#####.#.#.###.#.#########.#.###.#
#...#.......#...#...#...#...#.#.......#...#.#.#.#.#...#...#.......#.#.#...#.....#...#...#.#...#...#.#.#.#...#.....#...#...#.....#.....#.#...#
#####.#########.###########.#.#.#########.#.#.#.#.#.#####.#########.#.#####.#####.###.###.#####.###.#.#.#.###.#########.#######.#.#####.#.###
#.....#...#...#.#.....#.....#.#.###...#...#.#.#.#.#...#...#.......#.#...#...#...#...#.###.....#...#.#...#...#.......#...#...#...#.#...#.#...#
#.#####.#.#.#.#.#.###.#.#####.#.###.#.#.###.#.#.#.###.#.###.#####.#.###.#.###.#.###.#.#######.###.#.#######.#######.#.###.#.#.###.#.#.#.###.#
#.......#...#.#...#...#.....#.#.#...#.#.#...#.#.#.#...#.#...#####.#.#...#...#.#.#...#...#...#...#.#...#...#...#...#.#.#...#.#...#.#.#.#.#...#
#############.#####.#######.#.#.#.###.#.#.###.#.#.#.###.#.#######.#.#.#####.#.#.#.#####.#.#.###.#.###.#.#.###.#.#.#.#.#.###.###.#.#.#.#.#.###
#.......#.....#...#...#.....#.#.#.#...#.#...#.#.#.#...#.#...>.>.#...#.....#.#.#.#.....#.#.#.....#.###...#.#...#.#.#.#.#.#...###.#.#.#.#.#.###
#.#####.#.#####.#.###.#.#####.#.#.#.###.###.#.#.#.###.#.#####v#.#########.#.#.#.#####.#.#.#######.#######.#.###.#.#.#.#.#.#####.#.#.#.#.#.###
#.#...#...#...#.#...#.#.#.....#.#.#.>.>.#...#.#.#.#...#...#...#...###.....#.#.#.....#.#.#.......#.#...>.>.#.#...#.#.#.#.#.#...#.#.#.#...#...#
#.#.#v#####.#.#.###.#.#.#.#####.#.###v###.###.#.#.#.#####.#.#####.###.#####.#.#####.#.#.#######.#.#.###v###.#.###.#.#.#.#.#.#.#.#.#.#######.#
#...#.>.#...#...#...#.#.#...#...#.#...###.#...#.#.#...#...#.....#...#.....#.#.#.....#.#.#...#...#...###...#.#.#...#.#.#.#.#.#...#...###.....#
#####v#.#.#######.###.#.###.#.###.#.#####.#.###.#.###.#.#######.###.#####.#.#.#.#####.#.#.#.#.###########.#.#.#.###.#.#.#.#.###########.#####
#...#.#.#...###...#...#.#...#.....#.....#.#...#.#...#.#.#.......###...#...#.#.#...>.>.#.#.#.#...#.........#.#.#.#...#.#.#.#...#.....#...#...#
#.#.#.#.###.###.###.###.#.#############.#.###.#.###.#.#.#.###########.#.###.#.#####v###.#.#.###.#.#########.#.#.#.###.#.#.###.#.###.#.###.#.#
#.#...#.....#...#...#...#.#.........#...#.....#.....#.#.#.#...###.....#...#...#...#...#.#.#.....#...#.....#.#.#.#.#...#.#.#...#...#.#.....#.#
#.###########.###.###.###.#.#######.#.###############.#.#.#.#.###.#######.#####.#.###.#.#.#########.#.###.#.#.#.#.#.###.#.#.#####.#.#######.#
#.#...#.....#...#.###.#...#...#...#...#...###.........#.#...#...#.........#.....#.....#.#.....#...#...###.#...#...#...#.#.#.#.....#.#.......#
#.#.#.#.###.###.#.###.#.#####.#.#.#####.#.###.#########.#######.###########.###########.#####.#.#.#######.###########.#.#.#.#.#####.#.#######
#.#.#...#...###.#.###...#...#...#.......#.#...#...#...#...#.....#...#...###.........#...#...#.#.#.........#...###...#...#...#.....#...#.....#
#.#.#####.#####.#.#######.#.#############.#.###.#.#.#.###.#.#####.#.#.#.###########.#.###.#.#.#.###########.#.###.#.#############.#####.###.#
#...#...#...#...#...###...#...........#...#.#...#.#.#.#...#.......#...#.....###...#.#.#...#...#.#...#.....#.#.....#.#.....#.....#.......#...#
#####.#.###.#.#####.###.#############.#.###.#.###.#.#.#.###################.###.#.#.#.#.#######.#.#.#.###.#.#######.#.###.#.###.#########.###
#.....#.....#.......#...#.....#.....#...###.#...#.#.#.#.#...................#...#...#...###...#.#.#.#.#...#.#.......#...#.#...#...........###
#.###################.###.###.#.###.#######.###.#.#.#.#.#.###################.#############.#.#.#.#.#.#.###.#.#########.#.###.###############
#.............#...###...#.###...#...#.....#.#...#...#...#.............###...#...#.......#...#.#...#.#.#.....#.......#...#...#...........#...#
#############.#.#.#####.#.#######.###.###.#.#.#######################.###.#.###.#.#####.#.###.#####.#.#############.#.#####.###########.#.#.#
#...#.........#.#...###...###.....###.#...#...#...#...................#...#.....#.#.....#.#...#...#...#.............#.#...#.............#.#.#
#.#.#.#########.###.#########.#######.#.#######.#.#.###################.#########.#.#####.#.###.#.#####.#############.#.#.###############.#.#
#.#.#.#...#...#.#...#...#...#.....#...#.....###.#.#...................#.#...#...#.#...#...#...#.#.#...#.............#...#...#.........###.#.#
#.#.#v#.#.#.#.#.#.###.#.#.#.#####.#.#######.###.#.###################.#.#.#.#.#.#.###.#.#####.#.#.#.#.#############.#######.#.#######.###.#.#
#.#.#.>.#...#.#.#...#.#.#.#.#.....#.#.......#...#.....#...#...........#...#...#.#.#...#.#.....#.#...#.#.............###.....#...#.....#...#.#
#.#.#v#######.#.###.#.#.#.#.#.#####.#.#######.#######.#.#.#.###################v#.#.###.#.#####.#####.#.###############.#######.#.#####.###.#
#.#.#.###.....#.#...#.#.#.#.#.....#.#.......#...#.....#.#.#.#...#.........###.>.>.#...#.#.....#.....#.#.........#.....#.......#.#.#...#.#...#
#.#.#.###.#####.#.###.#.#.#.#####.#.#######.###.#.#####.#.#.#.#.#.#######.###.#v#####.#.#####.#####.#.#########.#.###.#######.#.#.#.#.#.#.###
#.#.#...#.#...#.#.###.#.#.#.#...#.#.#...#...#...#...#...#.#...#...#.......#...#...#...#.#.....#...#.#.#.........#.#...#...###...#...#...#...#
#.#.###.#.#.#.#.#.###.#.#.#.#.#.#v#.#.#.#.###.#####.#.###.#########.#######.#####.#.###.#.#####.#.#.#.#.#########.#.###.#.#################.#
#.#.....#...#.#.#...#.#.#.#.#.#.>.>.#.#...#...#.....#...#.#...#.....#...###...#...#.....#.#...#.#...#.#.....#...#.#.#...#.....#.......#...#.#
#.###########.#.###.#.#.#.#.#.###v###.#####.###.#######.#.#.#.#.#####.#.#####.#.#########.#.#.#.#####.#####.#.#.#.#.#.#######.#.#####.#.#.#.#
#.#.....#...#...#...#.#.#.#.#.#...#...#...#...#.#...###.#.#.#.#.....#.#.#...#.#.......#...#.#.#.#.....###...#.#.#.#.#.....#...#...###...#.#.#
#.#.###.#.#.#####.###.#.#.#.#.#.###.###.#.###.#.#.#.###.#.#.#.#####v#.#.#.#.#.#######.#.###.#.#.#.#######v###.#.#.#.#####.#.#####v#######.#.#
#...###...#.....#.....#...#...#...#.....#.#...#.#.#...#.#...#.#...>.>.#.#.#...#...#...#...#.#.#.#.#...#.>.>...#.#.#.#.....#.....>.#.....#...#
###############.#################.#######.#.###.#.###.#.#####.#.###v###.#.#####.#.#.#####.#.#.#.#.#.#.#.#v#####.#.#.#.###########v#.###.#####
###...#...#...#.#.........#.......#.....#.#.#...#.#...#.....#.#.###...#.#.#.....#.#...#...#.#.#.#.#.#...#.....#.#.#...#...........#.#...#...#
###.#.#.#.#.#.#.#.#######.#.#######.###.#.#.#.###.#.#######.#.#.#####.#.#.#.#####.###.#.###.#.#.#.#.#########.#.#.#####.###########.#.###.#.#
###.#...#...#...#.#.......#.........#...#...#.....#...#.....#...#...#.#.#.#.....#.....#...#.#.#.#...#.........#.#.....#...#...#...#.#...#.#.#
###.#############.#.#################.###############.#.#########.#.#.#.#.#####.#########.#.#.#.#####.#########.#####.###.#.#.#.#.#.###.#.#.#
#...#...........#.#.#.....#...#...###.....###...#...#...###.....#.#...#...#...#.......#...#.#.#.#.....#.......#.#.....#...#.#.#.#.#.#...#.#.#
#.###.#########.#.#.#.###.#.#.#.#.#######.###.#.#.#.#######.###.#.#########.#.#######.#.###.#.#.#.#####.#####.#.#.#####.###.#.#.#.#.#.###.#.#
#.....#.........#.#.#...#.#.#.#.#.#...#...#...#.#.#...#...#...#...###.......#.......#.#.....#...#...#...#...#.#.#...###.....#.#.#...#.....#.#
#######.#########.#.###.#.#.#.#.#.#.#.#v###.###.#.###.#.#.###.#######.#############.#.#############.#.###.#.#.#.###.#########.#.###########.#
#.......#...###...#...#.#...#...#...#.>.>.#...#.#.#...#.#.#...#...#...#.......#...#...#...#...#...#...#...#.#.#...#.........#...#.....#.....#
#.#######.#.###.#####.#.###############v#.###.#.#.#.###.#.#v###.#.#.###.#####.#.#.#####.#.#.#.#.#.#####.###.#.###.#########.#####.###.#v#####
#.......#.#...#.###...#...###.........#.#...#.#.#.#.#...#.>.>.#.#.#.....###...#.#.#...#.#.#.#.#.#...#...###...###...#.......#...#...#.>.#####
#######v#.###.#.###.#####.###.#######.#.###.#.#.#.#.#.#####v#.#.#.#########v###.#.#.#.#.#.#.#.#.###.#.#############.#.#######.#.###.###v#####
###...#.>.#...#.#...#...#...#.......#.#.###...#.#.#...#.....#...#.......#.>.>.#.#.#.#.#.#.#.#.#...#...#.....#...###...#...#...#.###...#.....#
###.#.#v###.###.#.###.#.###.#######.#.#.#######.#.#####.###############.#.#v#.#.#.#.#.#.#.#.#.###.#####.###.#.#.#######.#.#.###.#####.#####.#
#...#...###...#.#...#.#...#.###.....#...###.....#.....#.........#.......#.#.#...#.#.#.#.#.#.#.###.......#...#.#.#...###.#.#...#...#...#...#.#
#.###########.#.###.#.###.#.###.###########.#########.#########.#.#######.#.#####.#.#.#.#.#.#.###########.###.#.#.#.###.#.###.###.#.###.#.#.#
#...........#.#...#.#.#...#...#.#...#.....#.#...#...#.#.........#.........#.....#.#.#.#.#...#...###.......#...#.#.#...#.#...#...#...#...#...#
###########.#.###.#.#.#.#####.#.#.#.#.###.#.#.#.#.#.#.#.#######################.#.#.#.#.#######.###.#######.###.#.###.#.###.###.#####.#######
#...........#.#...#...#.#.....#...#...#...#.#.#.#.#...#.....#...#.....#...#...#.#.#.#.#.#...###...#.........#...#...#.#...#.#...#...#.....###
#.###########.#.#######.#.#############.###.#.#.#.#########.#.#.#.###.#.#.#.#.#.#.#.#.#.#.#.#####.###########.#####.#.###.#.#.###.#.#####.###
#...........#...###.....#.#.............###...#...#.........#.#...#...#.#...#...#...#...#.#.......###.........#...#.#.#...#.#.#...#.#...#...#
###########.#######.#####.#.#######################.#########.#####.###.#################.###########v#########.#.#.#.#.###.#.#.###.#.#.###.#
#...........###...#.#...#.#.........#####.......###...#.......#...#...#.#...............#.....#...#.>.>.......#.#.#.#.#.###...#...#.#.#.....#
#.#############.#.#.#.#.#.#########.#####.#####.#####.#.#######.#.###.#.#.#############.#####.#.#.#.#v#######.#.#.#.#.#.#########.#.#.#######
#.#.............#.#...#...#.......#.....#.....#.#...#...#...#...#.....#...#.......#.....#...#.#.#.#.#.....#...#.#.#.#.#.#.........#.#.......#
#.#.#############.#########.#####.#####.#####.#.#.#.#####.#.#.#############.#####.#.#####.#.#.#.#.#.#####.#.###.#.#.#.#.#.#########.#######.#
#.#.#...........#.........#.#...#.......#.....#.#.#.#...#.#.#.........#.....#####...#...#.#.#.#.#.#.#.....#.....#...#...#.......###.....#...#
#.#.#.#########.#########.#.#.#.#########.#####.#.#.#.#.#.#.#########.#.#############.#.#.#.#.#.#.#.#.#########################.#######.#.###
#.#.#.....#...#...........#...#.........#.....#.#.#.#.#.#.#.###.......#.........#...#.#...#.#...#...#...#.....#.......#...#####.....###...###
#.#.#####.#.#.#########################.#####.#.#.#.#.#.#.#.###v###############.#.#.#.#####.###########.#.###.#.#####.#.#.#########.#########
#...###...#.#.#...#...#.....#...........#.....#.#.#.#.#.#.#.#.>.>.###...#.......#.#.#.#.....#...#.......#.#...#...#...#.#.###...#...#...#####
#######v###.#.#.#.#.#.#.###.#.###########.#####.#.#.#.#.#.#.#.#v#.###.#.#.#######.#.#.#.#####.#.#.#######.#.#####.#.###.#.###v#.#.###.#.#####
#.....#.>...#...#...#.#.#...#...........#.....#.#.#.#.#...#.#.#.#...#.#.#...#...#.#.#.#.#...#.#.#.....#...#.#...#.#...#.#.#.>.#...###.#.....#
#.###.#v#############.#.#.#############.#####.#.#.#.#.#####.#.#.###.#.#.###.#.#.#.#.#.#.#.#.#.#.#####v#.###.#.#.#.###.#.#.#.#v#######.#####.#
#.#...#.#.............#.#...#...###.....#.....#...#...#...#...#...#...#...#.#.#.#.#.#.#.#.#.#.#.....>.>.#...#.#...#...#.#.#.#.........#...#.#
#.#.###.#.#############.###.#.#.###.#####.#############.#.#######.#######.#.#.#.#.#.#.#.#.#.#.#######v###.###.#####.###.#.#.###########.#.#.#
#.#.....#.#...#...#...#.#...#.#.#...#...#...........#...#.#.......#.......#.#.#.#.#.#.#.#.#...#.......###...#.#.....#...#.#.#...........#...#
#.#######.#.#.#.#.#.#.#.#.###.#.#.###.#.###########.#.###.#.#######.#######v#.#.#.#.#.#.#.#####.###########.#.#.#####.###.#.#.###############
#...#...#...#.#.#.#.#.#.#.###.#.#...#.#...#.....#...#...#.#.....###...#...>.>.#...#...#...#...#.....#...###.#.#.#...#...#...#.....#.........#
###.#.#.#####.#.#.#.#.#.#.###.#.###v#.###.#.###.#.#####.#.#####.#####.#.###v###############.#.#####.#.#.###.#.#.#.#.###.#########.#.#######.#
###...#...###.#.#.#.#.#.#...#.#.#.>.>.#...#...#.#...###.#.#...#.....#.#.#...#...#####.....#.#.#...#...#...#...#...#.....#.....#...#...#.....#
#########.###.#.#.#.#.#.###.#.#.#.#v###.#####.#.###.###.#.#.#.#####.#.#.#.###.#.#####.###.#.#.#.#.#######.###############.###.#.#####.#.#####
###...###...#...#...#.#.###...#...#...#.....#.#.#...#...#...#.#.....#...#.....#.....#...#...#...#.........#...#.........#...#.#.......#.....#
###.#.#####.#########.#.#############.#####.#.#.#.###.#######.#.###################.###.###################.#.#.#######.###.#.#############.#
###.#.#.....#...###...#.....#.......#.....#.#.#.#.#...#.....#...#...###.....#...#...###...#...#.............#.#.......#.....#...............#
###.#.#.#####.#.###.#######.#.#####.#####.#.#.#.#.#.###.###.#####.#.###.###.#.#.#.#######.#.#.#.#############.#######.#######################
#...#.#.......#...#...#.....#.....#.......#.#.#...#...#...#.#.....#...#...#...#...#.....#...#.#.#.............#...###.....#...#...#...#...###
#.###.###########.###.#.#########.#########.#.#######.###.#.#.#######.###.#########.###.#####.#.#.#############.#.#######.#.#.#.#.#.#.#.#.###
#...#...........#...#.#...###...#.#.......#...###...#.....#.#.#.......###.#...#...#.#...#...#...#.........#...#.#...#...#...#.#.#...#...#...#
###.###########.###.#.###.###.#.#.#.#####.#######.#.#######.#.#.#########.#.#.#.#.#.#.###.#.#############.#.#.#.###.#.#.#####.#.###########.#
###.#.........#.#...#.#...#...#.#...#.....#.....#.#.#.....#...#.........#...#.#.#...#...#.#.....#.....#...#.#.#.#...#.#.#...#...#.....#.....#
###.#.#######.#.#.###.#.###.###.#####.#####.###.#.#.#.###.#############.#####.#.#######.#.#####.#.###.#.###.#.#.#.###.#.#.#.#####.###.#.#####
#...#.#.......#...###.#.###...#.#...#.#...#...#.#.#.#.#...#...#.........#.....#.#.......#.#.....#...#...###.#.#.#.#...#.#.#.#...#...#.#.....#
#.###.#.#############.#.#####.#.#.#.#.#.#.###.#.#.#.#.#.###.#.#v#########.#####.#.#######.#.#######v#######.#.#.#.#.###.#.#.#.#.###.#.#####.#
#.....#.............#.#.#.....#.#.#.#.#.#...#.#.#.#.#.#.#...#.>.>.###...#.......#.......#.#.#...#.>.>.#...#.#.#.#.#...#.#.#.#.#.#...#...#...#
###################.#.#.#.#####.#.#.#v#.###.#.#.#.#.#.#.#.#####v#.###.#.###############v#.#.#.#.#.#v#.#.#.#.#.#.#.###.#.#.#.#.#.#v#####.#.###
#...................#...#.....#.#.#.>.>.###.#.#...#...#...#...#.#...#.#...#...#.......>.>.#.#.#.#.#.#...#.#.#.#.#.#...#.#.#.#.#.>.#...#.#...#
#.###########################.#.#.###v#####.#.#############.#.#.###.#.###.#.#.#.#######v###.#.#.#.#.#####.#.#.#.#.#.###.#.#.#.###v#.#.#.###.#
#.#.........###...#...###.....#.#.###.....#.#.#.............#.#.#...#...#.#.#.#.....#...###...#...#...#...#.#.#.#.#.#...#.#.#.#...#.#.#.....#
#.#.#######.###.#.#.#.###.#####.#.#######.#.#.#.#############.#.#.#####.#.#.#.#####.#.###############.#.###.#.#.#.#.#.###.#.#.#.###.#.#######
#.#.#...###...#.#.#.#...#.....#.#.#.......#...#...#...#.....#...#...#...#.#.#.#.....#.....#.....#.....#...#.#.#.#.#.#...#.#...#.....#.......#
#.#.#.#.#####.#.#.#.###.#####.#.#.#.#############.#.#.#.###.#######.#.###.#.#.#.#########.#.###.#.#######.#.#.#.#.#.###.#.#################.#
#.#.#.#.......#.#.#...#.#...#.#.#.#.....#.......#.#.#...###...#...#...###...#...#.......#...#...#.#.....#...#...#...###...#...#.....#...#...#
#.#.#.#########.#.###.#.#.#.#.#.#.#####.#.#####.#.#.#########.#.#.###############.#####.#####.###.#.###.###################.#.#.###.#.#.#.###
#...#.......###.#.#...#...#.#.#.#.#.....#.#.....#...#.........#.#.#...........#...#...#.......###...###.........#...........#...###...#.#.###
###########v###.#.#.#######.#.#.#.#.#####.#.#########.#########.#.#.#########.#.###.#.#########################.#.#####################.#.###
#...###...#.>.#.#.#.....#...#.#...#.......#.#.....###...........#...#.......#.#.#...#...........#...............#...#...#...........#...#...#
#.#.###.#.#v#.#.#.#####.#.###.#############.#.###.###################.#####.#.#.#.#############.#.#################.#.#.#.#########.#.#####.#
#.#.#...#...#...#.#...#.#.....#.......#...#...#...#.....#...........#.....#...#...###...#.......#...#...###...#...#...#...#.........#...#...#
#.#.#.###########.#.#.#.#######.#####.#.#.#####.###.###.#.#########.#####.###########.#.#.#########.#.#.###.#.#.#.#########.###########.#.###
#.#...#.........#.#.#.#...#...#.....#...#.......###...#.#.........#.......#.......#...#...#####...#...#.....#...#.#.........#...#.....#.#...#
#.#####.#######.#.#.#.###.#.#.#####.#################.#.#########.#########.#####.#.###########.#.###############.#.#########.#.#.###.#.###.#
#.......#.......#...#.....#.#.#...#.............#...#.#.#.........#.....###.....#.#.........#...#.................#...........#...#...#.#...#
#########.#################.#.#.#.#############.#.#.#.#.#.#########.###.#######.#.#########.#.#####################################.###.#.###
#.........#...#.....#.....#.#.#.#.#.............#.#.#.#.#.......###...#...#.....#...........#...........#.............#.......#.....#...#...#
#.#########.#.#.###.#.###.#.#.#.#.#.#############.#.#.#.#######.#####.###.#.###########################.#.###########.#.#####.#.#####.#####.#
#...........#.#.#...#.#...#.#...#.#.....#.......#.#...#.......#.#.....#...#.......#...........#.........#.#...........#.....#.#.....#.....#.#
#############.#.#.###.#.###.#####.#####.#.#####.#.###########.#.#.#####.#########.#.#########.#.#########.#.###############.#.#####.#####.#.#
#...........#...#.....#...#.....#.....#...#.....#...........#...#...#...#...#...#...#...#.....#...........#...#...###...#...#.....#.....#...#
#.#########.#############.#####.#####.#####.###############.#######.#.###.#.#.#.#####.#.#v###################.#.#.###.#.#.#######.#####.#####
#.........#...............#...#...#...#.....#...#...........###.....#.#...#.#.#...#...#.>.>...###...###.......#.#...#.#.#.#.....#.....#.#...#
#########.#################.#.###.#.###v#####.#.#.#############.#####.#.###.#.###.#.#########.###.#.###v#######.###.#.#.#.#.###.#####.#.#.#.#
###...###.........#.....#...#.#...#.#.>.>.###.#.#...#.........#.###...#.#...#.###...###.......#...#.#.>.>...#...#...#.#.#...###.....#...#.#.#
###.#.###########.#.###.#.###.#.###.#.###.###.#.###.#.#######.#.###.###.#.###.#########.#######.###.#.#####.#.###.###.#.###########.#####.#.#
#...#...........#.#...#.#.###.#.###.#.###...#.#.###...#.......#...#.#...#...#.........#.......#...#.#.#.....#.#...#...#...#...#...#...#...#.#
#.#############.#.###.#.#.###.#.###.#.#####.#.#.#######.#########.#.#.#####.#########.#######.###.#.#.#.#####.#.###.#####.#.#.#.#.###.#.###.#
#.#...#.......#...#...#.#...#.#.#...#...#...#.#.#...###.....###...#...#.....#.....#...#.......#...#.#.#...#...#.###...#...#.#.#.#.....#.#...#
#.#.#.#.#####.#####.###.###.#.#.#.#####.#.###.#.#.#.#######v###.#######.#####.###.#.###.#######.###.#.###.#.###.#####.#.###.#.#v#######.#.###
#.#.#...#.....#.....###...#.#.#.#.#...#.#...#.#.#.#...#...>.>.#.......#.....#...#.#...#.#.....#.###...###...#...#...#.#...#.#.>.###.....#...#
#.#.#####.#####.#########.#.#.#.#.#.#.#.###.#.#.#.###.#.#####.#######.#####.###.#.###.#.#.###.#.#############.###.#.#.###.#.###v###.#######.#
#.#.#.....#...#...###...#...#.#.#.#.#.#.#...#.#.#.#...#.....#...#.....#.....#...#.#...#...#...#...###.........#...#.#.#...#.###...#.#.......#
#.#.#.#####.#.###.###.#.#####.#.#.#.#.#.#.###.#.#.#.#######.###.#.#####.#####.###.#.#######.#####.###.#########.###.#.#.###.#####.#.#.#######
#.#.#...#...#...#.....#.....#.#.#.#.#.#.#.#...#.#.#...#...#...#.#.....#.#...#.###.#...#.....#...#...#.....#...#...#.#.#...#.#.....#.#.###...#
#.#.###.#.#####.###########.#.#.#.#.#.#.#.#.###.#.###.#.#.###.#.#####.#.#.#.#.###.###.#.#####.#.###.#####.#.#.###.#.#.###.#.#.#####.#.###.#.#
#...###...#####.............#...#...#...#...###...###...#.....#.......#...#...###.....#.......#.....#####...#.....#...###...#.......#.....#.#
###########################################################################################################################################.#'''
# text = '''#.#####
# #.....#
# #.#.#.#
# #.....#
# #####.#'''
# text = '''#.#####################
# #.......#########...###
# #######.#########.#.###
# ###.....#.>.>.###.#.###
# ###v#####.#v#.###.#.###
# ###.>...#.#.#.....#...#
# ###v###.#.#.#########.#
# ###...#.#.#.......#...#
# #####.#.#.#######.#.###
# #.....#.#.#.......#...#
# #.#####.#.#.#########v#
# #.#...#...#...###...>.#
# #.#.#v#######v###.###v#
# #...#.>.#...>.>.#.###.#
# #####v#.#.###v#.#.###.#
# #.....#...#...#.#.#...#
# #.#########.###.#.#.###
# #...###...#...#...#.###
# ###.###.#.###v#####v###
# #...#...#.#.>.>.#.>.###
# #.###.###.#.###.#.#v###
# #.....###...###...#...#
# #####################.#'''

grid = text.splitlines()

forking_nodes = {(0, 1), (len(grid) - 1, len(grid[0]) - 2)}
for x in range(len(grid)):
    for y in range(len(grid[0])):
        if grid[x][y] != '#' and len(get_neighbours((x, y), set(), True, grid)) > 2:
            forking_nodes.add((x, y))


def find_forking_neighbours(node, visited, all_normal, grid):

    if node in forking_nodes:
        return {(node, 0)}
    
    neighbours = set()
    for next_node in get_neighbours(node, visited, all_normal, grid):
        if next_node in visited:
            continue
        visited.add(next_node)
        for fork_node, distance in find_forking_neighbours(next_node, visited, all_normal, grid):
            neighbours.add((fork_node, distance + 1))
        visited.remove(next_node)
    return neighbours


from collections import defaultdict

edges = {}
for node in sorted(forking_nodes):
    forking_nodes.remove(node)
    for next_node, distance in find_forking_neighbours(node, {node}, True, grid):
        if (next_node, node) in edges:
            assert edges[(next_node, node)] == distance
            continue
        edges[(node, next_node)] = distance
    forking_nodes.add(node)


node_to_id = {
    node: index
    for index, node in enumerate(sorted(forking_nodes))
}

graph = defaultdict(list)
for (node, next_node), distance in sorted(edges.items(), key=lambda x: -x[-1]):
    graph[node_to_id[node]].append((node_to_id[next_node], distance))
    graph[node_to_id[next_node]].append((node_to_id[node], distance), )
    print(f'{node_to_id[node]} -- {node_to_id[next_node]} [label="{distance}"];')


def find_longest_path(node, end, mask):
    if node == end:
        return 0
    
    if (node, mask) in cache:
        return cache[(node, mask)]
    
    longest_path = -1
    for next_node, distance in graph[node]:
        if ((1 << next_node) & mask) != 0:
            continue
        if (t := find_longest_path(next_node, end, mask | (1 << next_node))) != -1:
            longest_path = max(longest_path, t + distance)
    cache[(node, mask)] = longest_path
    return longest_path


cache = {}
print(find_longest_path(min(graph), max(graph), 1 << min(graph)))
